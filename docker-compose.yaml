version: "3.8"

services:

    mysqldb:
      image: mysql:5.7
      restart: unless-stopped
      environment:
        #MYSQL_ROOT_PASSWORD=
        - MYSQL_ALLOW_EMPTY_PASSWORD=yes
        - MYSQL_DATABASE=achatdb
      ports:
        - 3306:3306
      volumes:
        - db:/var/lib/mysql
    prometheus:
      image: prom/prometheus
      container_name: prometheus-achat-backend
      volumes:
        - ./prometheus:/etc/prometheus
        - prometheus_data:/prometheus
        - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      command:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.agent.path=/prometheus'
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--web.enable-lifecycle'
        - '--enable-feature=agent'
      
      ports:
        - 9090:9090

    achat-backend:
        depends_on:
          - mysqldb
        image: saifdoghri7/achat:1.0.0
        restart: on-failure
        ports:
          - 8082:8082
        environment:
          SPRING_APPLICATION_JSON: '{
                "spring.datasource.url"  : "jdbc:mysql://mysqldb:3306/achatdb?createDatabaseIfNotExist=true&useUnicode=true&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=UTC",
                "spring.datasource.username" : "root",
                "spring.datasource.password" : "",
                "spring.jpa.properties.hibernate.dialect" : "org.hibernate.dialect.MySQL5InnoDBDialect",
                "spring.jpa.hibernate.ddl-auto" : "update"
        }'

        stdin_open: true
        tty: true
volumes:
    db:
    prometheus_data:
